include /etc/nginx/conf.d/include/proxy-buffer;
include /etc/nginx/conf.d/include/proxy-pass-internal;

set $dnslink '';

rewrite_by_lua_block {
    local httpc = require("resty.http").new()
    local res, err = httpc:request_uri("http://10.10.10.55:3100/dnslink/" .. ngx.var.host)

    if err or res and res.status ~= ngx.HTTP_OK then
        ngx.status = err and ngx.HTTP_INTERNAL_SERVER_ERROR or res.status
        ngx.header["content-type"] = "text/plain"
        ngx.say(err or res.body)
        ngx.exit(err and ngx.HTTP_INTERNAL_SERVER_ERROR or res.status)
    else
        ngx.var.dnslink = res.body
    end
}

proxy_pass https://127.0.0.1/$dnslink$request_uri;