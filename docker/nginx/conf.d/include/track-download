# register the download in accounts service (cookies should contain jwt)
log_by_lua_block {
    -- this block runs only when accounts are enabled
    if os.getenv("ACCOUNTS_ENABLED") ~= "true" then return end

    local skylink = ngx.header["Skynet-Skylink"]
    if skylink and ngx.status >= ngx.HTTP_OK and ngx.status < ngx.HTTP_SPECIAL_RESPONSE then
        local httpc = require("resty.http").new()
        local query = table.concat({ "status=" .. ngx.status, "bytes=" .. ngx.var.body_bytes_sent }, "&")
        local res, err = httpc:request_uri("http://10.10.10.70:3000/track/download/" .. skylink .. "?" .. query, {
            method = "POST",
            headers = { ["Cookie"] = ngx.header["Cookie"] },
        })
        if err or res and res.status ~= ngx.HTTP_NO_CONTENT then
            ngx.log(ngx.ERR, "accounts endpoint /track/download/" .. skylink .. " failed with error " .. err or res.body)
        end
    end
}
